from math import pi
import glm
import numpy as np

from engine.shadeable_object import ShadeableObject
from models.helpers import triangle_vertices_from_indices
from engine.animation import AnimationLerper, AnimationLerpFunction, Animator

vertex_palette = [
    (0.0, 0.0, -1.0),
    (0.7236073017120361, -0.5257253050804138, -0.44721952080726624),
    (-0.276388019323349, -0.8506492376327515, -0.4472198486328125),
    (-0.8944262266159058, 0.0, -0.44721561670303345),
    (-0.276388019323349, 0.8506492376327515, -0.4472198486328125),
    (0.7236073017120361, 0.5257253050804138, -0.44721952080726624),
    (0.276388019323349, -0.8506492376327515, 0.4472198486328125),
    (-0.7236073017120361, -0.5257253050804138, 0.44721952080726624),
    (-0.7236073017120361, 0.5257253050804138, 0.44721952080726624),
    (0.276388019323349, 0.8506492376327515, 0.4472198486328125),
    (0.8944262266159058, 0.0, 0.44721561670303345),
    (0.0, 0.0, 1.0),
    (-0.16245555877685547, -0.49999526143074036, -0.8506544232368469),
    (0.42532268166542053, -0.30901139974594116, -0.8506541848182678),
    (0.26286882162094116, -0.8090116381645203, -0.5257376432418823),
    (0.8506478667259216, 0.0, -0.5257359147071838),
    (0.42532268166542053, 0.30901139974594116, -0.8506541848182678),
    (-0.525729775428772, 0.0, -0.8506516814231873),
    (-0.6881893873214722, -0.49999693036079407, -0.5257362127304077),
    (-0.16245555877685547, 0.49999526143074036, -0.8506544232368469),
    (-0.6881893873214722, 0.49999693036079407, -0.5257362127304077),
    (0.26286882162094116, 0.8090116381645203, -0.5257376432418823),
    (0.9510578513145447, -0.30901262164115906, 0.0),
    (0.9510578513145447, 0.30901262164115906, 0.0),
    (0.0, -0.9999999403953552, 0.0),
    (0.5877856016159058, -0.8090167045593262, 0.0),
    (-0.9510578513145447, -0.30901262164115906, 0.0),
    (-0.5877856016159058, -0.8090167045593262, 0.0),
    (-0.5877856016159058, 0.8090167045593262, 0.0),
    (-0.9510578513145447, 0.30901262164115906, 0.0),
    (0.5877856016159058, 0.8090167045593262, 0.0),
    (0.0, 0.9999999403953552, 0.0),
    (0.6881893873214722, -0.49999693036079407, 0.5257362127304077),
    (-0.26286882162094116, -0.8090116381645203, 0.5257376432418823),
    (-0.8506478667259216, 0.0, 0.5257359147071838),
    (-0.26286882162094116, 0.8090116381645203, 0.5257376432418823),
    (0.6881893873214722, 0.49999693036079407, 0.5257362127304077),
    (0.16245555877685547, -0.49999526143074036, 0.8506543636322021),
    (0.525729775428772, 0.0, 0.8506516814231873),
    (-0.42532268166542053, -0.30901139974594116, 0.8506541848182678),
    (-0.42532268166542053, 0.30901139974594116, 0.8506541848182678),
    (0.16245555877685547, 0.49999526143074036, 0.8506543636322021),
]

face_vertices = [
    (0, 13, 12),
    (1, 13, 15),
    (0, 12, 17),
    (0, 17, 19),
    (0, 19, 16),
    (1, 15, 22),
    (2, 14, 24),
    (3, 18, 26),
    (4, 20, 28),
    (5, 21, 30),
    (1, 22, 25),
    (2, 24, 27),
    (3, 26, 29),
    (4, 28, 31),
    (5, 30, 23),
    (6, 32, 37),
    (7, 33, 39),
    (8, 34, 40),
    (9, 35, 41),
    (10, 36, 38),
    (38, 41, 11),
    (38, 36, 41),
    (36, 9, 41),
    (41, 40, 11),
    (41, 35, 40),
    (35, 8, 40),
    (40, 39, 11),
    (40, 34, 39),
    (34, 7, 39),
    (39, 37, 11),
    (39, 33, 37),
    (33, 6, 37),
    (37, 38, 11),
    (37, 32, 38),
    (32, 10, 38),
    (23, 36, 10),
    (23, 30, 36),
    (30, 9, 36),
    (31, 35, 9),
    (31, 28, 35),
    (28, 8, 35),
    (29, 34, 8),
    (29, 26, 34),
    (26, 7, 34),
    (27, 33, 7),
    (27, 24, 33),
    (24, 6, 33),
    (25, 32, 6),
    (25, 22, 32),
    (22, 10, 32),
    (30, 31, 9),
    (30, 21, 31),
    (21, 4, 31),
    (28, 29, 8),
    (28, 20, 29),
    (20, 3, 29),
    (26, 27, 7),
    (26, 18, 27),
    (18, 2, 27),
    (24, 25, 6),
    (24, 14, 25),
    (14, 1, 25),
    (22, 23, 10),
    (22, 15, 23),
    (15, 5, 23),
    (16, 21, 5),
    (16, 19, 21),
    (19, 4, 21),
    (19, 20, 4),
    (19, 17, 20),
    (17, 3, 20),
    (17, 18, 3),
    (17, 12, 18),
    (12, 2, 18),
    (15, 16, 5),
    (15, 13, 16),
    (13, 0, 16),
    (12, 14, 2),
    (12, 13, 14),
    (13, 1, 14),
]

RESOLUTION = 5

class Star(ShadeableObject):
    def __init__(self, ctx, camera, scale):
        shader_name = "star"
        shader_inputs = {"in_position": "3f"}
        vertices = triangle_vertices_from_indices(vertex_palette, face_vertices)
        super().__init__(ctx, shader_name, shader_inputs, vertices)
        self.camera = camera
        self.scale_matrix = glm.scale(2 * glm.vec3(scale, scale, scale))
        self.set_uniform("u_resolution", glm.vec2(RESOLUTION, RESOLUTION))
        self.time = 0.0

        self.rotate_animator = Animator(
            lerper=AnimationLerper(AnimationLerpFunction.linear, 1500),
            start_value=0.0,
            infinite=True,
        )
        self.rotate_animator.start(2.0 * pi)

    def render(self, delta_time):
        self.time += delta_time
        self.shader["u_time"] = self.time * 0.01
        angle = self.rotate_animator.frame(delta_time)
        matrix = self.camera.view_projection_matrix * self.scale_matrix * glm.rotate(angle, glm.vec3(0, 0, 1))
        self.set_uniform("m_mvp", matrix)

        super().render()
